<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=https://htdocs.dev/cookbooks/postfix/rate_limiting/ rel=canonical><meta name=author content="Stephane Busso"><link rel="shortcut icon" href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.1.2, mkdocs-material-5.5.13"><title>Rate limiting - HTDOCS</title><link rel=stylesheet href=../../../assets/stylesheets/main.077507d7.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.ff0a5ce4.min.css><meta name=theme-color content=#2094f3><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style><link rel=stylesheet href=../../../stylesheets/extra.css><link rel=stylesheet href=../../../stylesheets/dracula.css></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=blue data-md-color-accent> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#61-add-policies-in-etcpostfixmastercf class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid" aria-label=Header> <a href=https://htdocs.dev title=HTDOCS class="md-header-nav__button md-logo" aria-label=HTDOCS> <img src=../../../assets/logo.png alt=logo> </a> <label class="md-header-nav__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header-nav__title data-md-component=header-title> <div class=md-header-nav__ellipsis> <span class="md-header-nav__topic md-ellipsis"> HTDOCS </span> <span class="md-header-nav__topic md-ellipsis"> Rate limiting </span> </div> </div> <label class="md-header-nav__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label=Clear data-md-component=search-reset tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header-nav__source> <a href=https://github.com/htdocs-dev/site/ title="Go to repository" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class="md-tabs md-tabs--active" aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Welcome to HTDocs </a> </li> <li class=md-tabs__item> <a href=../../ class="md-tabs__link md-tabs__link--active"> Cookbooks </a> </li> <li class=md-tabs__item> <a href=../../../projects/Tailwind%20Semantic%20UI/ class=md-tabs__link> Projects </a> </li> <li class=md-tabs__item> <a href=../../../contact/ class=md-tabs__link> Contact </a> </li> <li class=md-tabs__item> <a href=../../../links/online-dev/ class=md-tabs__link> Links </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=https://htdocs.dev title=HTDOCS class="md-nav__button md-logo" aria-label=HTDOCS> <img src=../../../assets/logo.png alt=logo> </a> HTDOCS </label> <div class=md-nav__source> <a href=https://github.com/htdocs-dev/site/ title="Go to repository" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. title="Welcome to HTDocs" class=md-nav__link> Welcome to HTDocs </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-2 type=checkbox id=nav-2 checked> <label class=md-nav__link for=nav-2> Cookbooks <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Cookbooks data-md-level=1> <label class=md-nav__title for=nav-2> <span class="md-nav__icon md-icon"></span> Cookbooks </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../ title=Index class=md-nav__link> Index </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-2-2 type=checkbox id=nav-2-2> <label class=md-nav__link for=nav-2-2> Docker swarm <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Docker swarm" data-md-level=2> <label class=md-nav__title for=nav-2-2> <span class="md-nav__icon md-icon"></span> Docker swarm </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../docker_swarm/ title=Index class=md-nav__link> Index </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-2-3 type=checkbox id=nav-2-3> <label class=md-nav__link for=nav-2-3> Google cloud <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Google cloud" data-md-level=2> <label class=md-nav__title for=nav-2-3> <span class="md-nav__icon md-icon"></span> Google cloud </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../google-cloud/ title=Index class=md-nav__link> Index </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-2-4 type=checkbox id=nav-2-4> <label class=md-nav__link for=nav-2-4> Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Kubernetes data-md-level=2> <label class=md-nav__title for=nav-2-4> <span class="md-nav__icon md-icon"></span> Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kubernetes/ title=Index class=md-nav__link> Index </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-2-5 type=checkbox id=nav-2-5> <label class=md-nav__link for=nav-2-5> Portainer <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Portainer data-md-level=2> <label class=md-nav__title for=nav-2-5> <span class="md-nav__icon md-icon"></span> Portainer </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../portainer/ title=Index class=md-nav__link> Index </a> </li> <li class=md-nav__item> <a href=../../portainer/wordpress/ title="Easy Wordpress hosting with Docker and Portainer" class=md-nav__link> Easy Wordpress hosting with Docker and Portainer </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-2-6 type=checkbox id=nav-2-6> <label class=md-nav__link for=nav-2-6> Vuejs3 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Vuejs3 data-md-level=2> <label class=md-nav__title for=nav-2-6> <span class="md-nav__icon md-icon"></span> Vuejs3 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../vuejs3/ title="From Vuejs 2.0" class=md-nav__link> From Vuejs 2.0 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3 type=checkbox id=nav-3> <label class=md-nav__link for=nav-3> Projects <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Projects data-md-level=1> <label class=md-nav__title for=nav-3> <span class="md-nav__icon md-icon"></span> Projects </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-1 type=checkbox id=nav-3-1> <label class=md-nav__link for=nav-3-1> Tailwind Semantic UI <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Tailwind Semantic UI" data-md-level=2> <label class=md-nav__title for=nav-3-1> <span class="md-nav__icon md-icon"></span> Tailwind Semantic UI </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../projects/Tailwind%20Semantic%20UI/ title="Tailwind Semantic UI" class=md-nav__link> Tailwind Semantic UI </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../projects/cloud_mta/ title=Index class=md-nav__link> Index </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-3 type=checkbox id=nav-3-3> <label class=md-nav__link for=nav-3-3> Cloud pipeline <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Cloud pipeline" data-md-level=2> <label class=md-nav__title for=nav-3-3> <span class="md-nav__icon md-icon"></span> Cloud pipeline </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../projects/cloud_pipeline/ title="Cloud Pipeline" class=md-nav__link> Cloud Pipeline </a> </li> <li class=md-nav__item> <a href=../../../projects/cloud_pipeline/airflow_docker/ title="Airflow and Docker" class=md-nav__link> Airflow and Docker </a> </li> <li class=md-nav__item> <a href=../../../projects/cloud_pipeline/luigi_docker/ title="Luigi docker" class=md-nav__link> Luigi docker </a> </li> <li class=md-nav__item> <a href=../../../projects/cloud_pipeline/prefect/ title=Prefect class=md-nav__link> Prefect </a> </li> <li class=md-nav__item> <a href=../../../projects/cloud_pipeline/vocabulary/ title=Vocabulary class=md-nav__link> Vocabulary </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-4 type=checkbox id=nav-3-4> <label class=md-nav__link for=nav-3-4> Repositories <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Repositories data-md-level=2> <label class=md-nav__title for=nav-3-4> <span class="md-nav__icon md-icon"></span> Repositories </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../projects/repositories/all/ title=Repositories class=md-nav__link> Repositories </a> </li> <li class=md-nav__item> <a href=../../../projects/repositories/alpine-curl/ title="Alpine curl" class=md-nav__link> Alpine curl </a> </li> <li class=md-nav__item> <a href=../../../projects/repositories/bear-power-pack/ title="Bear Power Pack" class=md-nav__link> Bear Power Pack </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> Contact <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Contact data-md-level=1> <label class=md-nav__title for=nav-4> <span class="md-nav__icon md-icon"></span> Contact </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../contact/ title=Contact class=md-nav__link> Contact </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-5 type=checkbox id=nav-5> <label class=md-nav__link for=nav-5> Links <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Links data-md-level=1> <label class=md-nav__title for=nav-5> <span class="md-nav__icon md-icon"></span> Links </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../links/online-dev/ title="Online dev" class=md-nav__link> Online dev </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/htdocs-dev/site/edit/master/docs/cookbooks/postfix/rate_limiting.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg> </a> <p>(<a href=http://steam.io/2013/04/01/postfix-rate-limiting/ >http://steam.io/2013/04/01/postfix-rate-limiting/</a>) <a href=http://wiki.wordtothewise.com/ISP_Summary_Information>http://wiki.wordtothewise.com/ISP_Summary_Information</a></p> <h2 id=61-add-policies-in-etcpostfixmastercf>6.1. Add policies in /etc/postfix/master.cf<a class=headerlink href=#61-add-policies-in-etcpostfixmastercf title="Permanent link">&para;</a></h2> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2</pre></div></td><td class=code><div class=highlight><pre><span></span><code>polite unix - - n - - smtp
turtle unix - - n - - smtp
</code></pre></div> </td></tr></table> <ol start=2> <li> <p>Map domain to its transport name. For this add the following to <code>/etc/postfix/transport</code></p> <p>gmail.com polite: yahoo.com turtle: hotmail.com polite: aol.com turtle:</p> </li> <li> <p>Modify postfix configuration to specify the rate limit,</p> <p>postconf -e &ldquo;polite_destination_concurrency_limit = 4&rdquo; postconf -e &ldquo;polite_destination_rate_delay = 0&rdquo; postconf -e &ldquo;polite_destination_recipient_limit = 10&rdquo; postconf -e &ldquo;turtle_destination_rate_delay = 3s&rdquo; postconf -e &ldquo;turtle_destination_concurrency_limit = 20&rdquo; postconf -e &ldquo;turtle_destination_recipient_limit = 4&rdquo;</p> </li> </ol> <p>Restart postfix</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=highlight><pre><span></span><code>service postfix restart
</code></pre></div> </td></tr></table> <p>other solution</p> <p>Now, define required additional transport in postfix master.cf file:</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2</pre></div></td><td class=code><div class=highlight><pre><span></span><code>smtp-gmail unix -    -    n    -    1    smtp
      -o syslog_name=smtp-gmail
</code></pre></div> </td></tr></table> <p>Define the required throttling (rate limits) settings in postfix main.cf</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4</pre></div></td><td class=code><div class=highlight><pre><span></span><code>smtp-gmail_destination_rate_delay = 12s
smtp-gmail_destination_concurrency_limit = 1
smtp-gmail_destination_recipient_limit = 2
smtp-gmail_initial_destination_concurrency=1
</code></pre></div> </td></tr></table> <p>The syntax is as follows: <code>transtport-name_variable-name=value</code></p> <p>Add the following to /etc/postfix/transport</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=highlight><pre><span></span><code>/\@gmail\.com$/       smtp-gmail:
</code></pre></div> </td></tr></table> <p>The format of the above file is regexp. Lookups to regexp tables are fast so probably you should use those. For regexp to work you should have regexp support built into postfix. Find out using this command</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=highlight><pre><span></span><code>postconf -m
</code></pre></div> </td></tr></table> <p>Once the transport file is created, make sure to create the corresponding db, which will be actually used by postfix. Use postmap command.</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=highlight><pre><span></span><code>  postmap  /etc/postfix/transport
</code></pre></div> </td></tr></table> <p>Make postfix use this transport table. Edit main.cf and add the following:</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=highlight><pre><span></span><code>transport_maps = regexp:/etc/postfix/transport
</code></pre></div> </td></tr></table> <p>Make sure you use regexp prefix.</p> <p>Reload postfix</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class=code><div class=highlight><pre><span></span><code>postfix reload



transport_maps = hash:/etc/postfix/transport, regexp:/etc/postfix/transport_gmail

# cat /etc/postfix/transport_gmail
/\@gmail\.com$/ smtp-gmail:
</code></pre></div> </td></tr></table> <div class="admonition note"> <p class=admonition-title>Note</p> <p>No need to postmap this file</p> </div> <p>Delay=2s caused transport invocation every 4 seconds in my experience.</p> <p><code>/etc/postfix/transport</code> file like this:</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65</pre></div></td><td class=code><div class=highlight><pre><span></span><code># Yahoo (USA)
yahoo.com       yahoo:
ymail.com       yahoo:
rocketmail.com  yahoo:

# Yahoo (INTL)
yahoo.ae        yahoo:
yahoo.at        yahoo:
yahoo.be        yahoo:
yahoo.ca        yahoo:
yahoo.ch        yahoo:
yahoo.cn        yahoo:
yahoo.co.il     yahoo:
yahoo.co.in     yahoo:
yahoo.co.jp     yahoo:
yahoo.co.kr     yahoo:
yahoo.co.nz     yahoo:
yahoo.co.th     yahoo:
yahoo.co.uk     yahoo:
yahoo.co.za     yahoo:
yahoo.com.ar    yahoo:
yahoo.com.au    yahoo:
yahoo.com.br    yahoo:
yahoo.com.cn    yahoo:
yahoo.com.hk    yahoo:
yahoo.com.mx    yahoo:
yahoo.com.my    yahoo:
yahoo.com.ph    yahoo:
yahoo.com.sg    yahoo:
yahoo.com.tr    yahoo:
yahoo.com.tw    yahoo:
yahoo.com.vn    yahoo:
yahoo.cz        yahoo:
yahoo.de        yahoo:
yahoo.dk        yahoo:
yahoo.en        yahoo:
yahoo.es        yahoo:
yahoo.fi        yahoo:
yahoo.fr        yahoo:
yahoo.gr        yahoo:
yahoo.ie        yahoo:
yahoo.it        yahoo:
yahoo.nl        yahoo:
yahoo.no        yahoo:
yahoo.pl        yahoo:
yahoo.pt        yahoo:
yahoo.ro        yahoo:
yahoo.ru        yahoo:
yahoo.se        yahoo:
# Yahoo
ymail.com       yahoo:
rocketmail.com  yahoo:
yahoo.com   smtpslow:
gmail.com   smtpslow:
hotmail.com smtpslow:
aol.com     smtpslow:
comcast.com smtpslow:
live.com    smtpslow:
msn.com     smtpslow:
sbcglobal.net smtpslow:
verizon.net     smtpslow:
bellsouth.net smtpslow:
yahoo.ca    smtpslow:
cox.net     smtpslow:
ymail.com   smtpslow:
</code></pre></div> </td></tr></table> <p>Once you’re done editing the /etc/postfix/transport file (and after every edit from now on), remember to do: # postmap /etc/postfix/transport</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class=code><div class=highlight><pre><span></span><code>/etc/postfix/transport.regexp that looks like this:

# Yahoo Wildcards
/yahoo(\.[a-z]{2,3}){1,2}$/  yahoo:

yahoo     unix  -       -       n       -       -       smtp
        -o syslog_name=postfix-yahoo
</code></pre></div> </td></tr></table> <p>Back up your /etc/postfix/main.cf file, then add these lines:</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6</pre></div></td><td class=code><div class=highlight><pre><span></span><code>transport_maps = hash:/etc/postfix/transport, regexp:/etc/postfix/transport.regexp

yahoo_initial_destination_concurrency = 1
yahoo_destination_concurrency_limit = 4
yahoo_destination_recipient_limit = 2
yahoo_destination_rate_delay = 1s
</code></pre></div> </td></tr></table> <p>This tells Postfix to check your /etc/postfix/transport and /etc/postfix/transport.regexp files to look up which domains you’ve mapped to which transport, then it sets four specific configurations for the “yahoo” transport:</p> <ul> <li><code>yahoo_initial_destination_concurrency = 1</code> will start out slowly by only sending one message per SMTP connection to a Yahoo’s MTA.</li> <li><code>yahoo_destination_concurrency_limit = 4</code> after starting out slowly with just 1 message, Postfix will increase to allow up to four messages per SMTP connection to a Yahoo MTA.</li> <li><code>yahoo_destination_recipient_limit = 2</code> will send the same message to no more than 2 recipients at a time</li> <li><code>yahoo_destination_rate_delay = 1s</code> will add a 1 second delay between the messages</li> </ul> <p>final version:</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class=code><div class=highlight><pre><span></span><code>/pronostic-facile\.fr/ relay:[ASPMX.L.GOOGLE.COM]

/gmail\.com/ polite:
/yahoo\.com/ turtle:
/hotmail(\.[a-z]{2,3}){1,2}$/ polite:
/live(\.[a-z]{2,3}){1,2}$/ polite:
/outlook(\.[a-z]{2,3}){1,2}$/ polite:
/aol\.com/  turtle:
/yahoo(\.[a-z]{2,3}){1,2}$/ turtle:
</code></pre></div> </td></tr></table> <p>Basically, you may take the following steps as reference:</p> <ul> <li> <p>Create a seperate mail for the destination is yahoo, let&rsquo;s name it &lsquo;slow&rsquo; queue (You may search in this mailling list too, someone has asked before)</p> </li> <li> <p>After Postfix 2.5, set slow_destination_rate_delay for certain period of time for &lsquo;slow&rsquo; In my case, I set to 300s. That&rsquo;s mean 5 mins per delivery to yahoo</p> </li> <li> <p>Set slow_destination_concurrency_limit &amp; slow_destination_recipient_limit for &lsquo;slow&rsquo; In may case, I set slow_destination_concurrency_limit = 2 slow_destination_recipient_limit = 10</p> </li> <li> <p>In Postfix 2.5.5 or earlier, disable defer retry failure giving up limit for &lsquo;slow&rsquo;. I my case, I set slow_concurrency_failed_cohort_limit = $slow_destination_concurrency_failed_cohort_limit slow_destination_concurrency_failed_cohort_limit = 0</p> </li> </ul> <h2 id=step-1-setting-up-the-transport-maps>STEP 1: SETTING UP THE TRANSPORT MAPS<a class=headerlink href=#step-1-setting-up-the-transport-maps title="Permanent link">&para;</a></h2> <p>The first step is to determine which domains you want to treat differently. Obviously, in this example, we’re trying to set up something to eliminate (or at least reduce) Yahoo’s deferrals. So edit the /etc/postfix/transport file and create some maps that tell Postfix exactly which email domains are going to get the special “Yahoo” treatment. The email domain goes on the left, and the name of your custom transport goes on the right (always followed by a colon). The most basic approach would be to specifically list all the Yahoo email domains you want to cover in your /etc/postfix/transport file like this:</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=highlight><pre><span></span><code># Yahoo (USA) yahoo.com       yahoo: ymail.com       yahoo: rocketmail.com  yahoo:  # Yahoo (INTL) yahoo.ae        yahoo: yahoo.at        yahoo: yahoo.be        yahoo: yahoo.ca        yahoo: yahoo.ch        yahoo: yahoo.cn        yahoo: yahoo.co.il     yahoo: yahoo.co.in     yahoo: yahoo.co.jp     yahoo: yahoo.co.kr     yahoo: yahoo.co.nz     yahoo: yahoo.co.th     yahoo: yahoo.co.uk     yahoo: yahoo.co.za     yahoo: yahoo.com.ar    yahoo: yahoo.com.au    yahoo: yahoo.com.br    yahoo: yahoo.com.cn    yahoo: yahoo.com.hk    yahoo: yahoo.com.mx    yahoo: yahoo.com.my    yahoo: yahoo.com.ph    yahoo: yahoo.com.sg    yahoo: yahoo.com.tr    yahoo: yahoo.com.tw    yahoo: yahoo.com.vn    yahoo: yahoo.cz        yahoo: yahoo.de        yahoo: yahoo.dk        yahoo: yahoo.en        yahoo: yahoo.es        yahoo: yahoo.fi        yahoo: yahoo.fr        yahoo: yahoo.gr        yahoo: yahoo.ie        yahoo: yahoo.it        yahoo: yahoo.nl        yahoo: yahoo.no        yahoo: yahoo.pl        yahoo: yahoo.pt        yahoo: yahoo.ro        yahoo: yahoo.ru        yahoo: yahoo.se        yahoo:
</code></pre></div> </td></tr></table> <p>However, listing all those domains forces you to stay up to date with any new domains that Yahoo might launch. So a smarter approach would be to two transport maps: one that’s a regular hash table, and another with a regular expression that simply catches any domain that starts with yahoo. First, put ymail.com and rocketmail.com in your /etc/postfix/transport file, like this:</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2</pre></div></td><td class=code><div class=highlight><pre><span></span><code># Yahoo ymail.com
yahoo: rocketmail.com  yahoo:
</code></pre></div> </td></tr></table> <p>Once you’re done editing the /etc/postfix/transport file (and after every edit from now on), remember to do:</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=highlight><pre><span></span><code>postmap /etc/postfix/transport
</code></pre></div> </td></tr></table> <p>to build the transport.db file. Next, create a file called /etc/postfix/transport.regexp that looks like this:</p> <h1 id=yahoo-wildcards-yahooa-z2312-yahoo>Yahoo Wildcards /yahoo(.[a-z]{2,3}){1,2}$/ yahoo:<a class=headerlink href=#yahoo-wildcards-yahooa-z2312-yahoo title="Permanent link">&para;</a></h1> <p>That will catch all “yahoo dot anything” domains. Note that you don’t need to run postmap on regular expression tables, so now you’re ready to tell Postfix how to read your transports. Step 2: Include the New Custom Transports in master.cf As always, before messing with /etc/postfix/master.cf, make a backup. Then add the following lines at the bottom: yahoo unix - - n - - smtp -o syslog_name=postfix-yahoo -o smtp_connect_timeout=5 -o smtp_helo_timeout=5</p> <p>This tells Postfix that the transport called “yahoo” gets handed off to the Postfix smtp process, and the -o syslog_name option tags the use of this transport in the mail log so I easily tell when this transport is used. Step 3: Create Custom Settings in main.cf The third step of the process is to create some custom settings in your main.cf file to tell Postfix exactly what to do differently when it encounters an outbound mail domain that matches your transport maps. Back up your /etc/postfix/main.cf file, then add these lines: transport_maps = hash:/etc/postfix/transport, regexp:/etc/postfix/transport.regexp yahoo_initial_destination_concurrency = 1 yahoo_destination_concurrency_limit = 4 yahoo_destination_recipient_limit = 2 yahoo_destination_rate_delay = 1s This tells Postfix to check your /etc/postfix/transport and/etc/postfix/transport.regexp files to look up which domains you’ve mapped to which transport, then it sets four specific configurations for the “yahoo” transport: • yahoo_initial_destination_concurrency = 1 will start out slowly by only sending one message per SMTP connection to a Yahoo’s MTA. • yahoo_destination_concurrency_limit = 4 after starting out slowly with just 1 message, Postfix will increase to allow up to four messages per SMTP connection to a Yahoo MTA. • yahoo_destination_recipient_limit = 2 will send the same message to no more than 2 recipients at a time • yahoo_destination_rate_delay = 1s will add a 1 second delay between the messages This is where the Postfix voodoo kicks in for me, so feel free to experiment with these settings and tweak to your liking. The destination concurrency limit and the rate delay are the two you’ll probably want to tinker to keep Yahoo happy. Depending on your mailer reputation, they’ll be more strict or more relaxed on what they’ll allow for these two settings. The above settings that happen to work for my needs, but I still tweak them to experiment, and if you have a configuration that works well with Yahoo (or if you have other custom transports that help increase delivery), please feel free to share them in the comments. Step 4: Restart Postfix and Test Now you’re ready to try things out. Start the Postfix configuration with:</p> <h1 id=service-postfix-restart>service postfix restart<a class=headerlink href=#service-postfix-restart title="Permanent link">&para;</a></h1> <p>You can’t just do a postfix reload, because changes to the master.cf require a full restart. Finally, do a tail -f on your maillog. On my CentOS system, that’s: tail -f /var/log/maillog Now send a message to a Yahoo test account (I’m assuming you have an @yahoo.com test account) from or through your Postfix server. If everything worked right, you should see log entries that start with the date, local hostname, and then say postfix-yahoo/smtp. These are the messages that are being diverted through your new transport! After using these settings for a few mailings, I’ve seen a drastic reduction in the amount of time it takes to deliver tens of thousands of opt-in email to Yahoo recipients. Hopefully, they’ll work for you, too! Your feedback and comments are welcome below, and I’m especially interested to hear of any other custom transports you may be using, as well as your experiences with different settings for Yahoo.   La file des messages se rempli alors très rapidement pour monter facilement à plusieurs dizaine de milliers de mails en attente d’envoi et surtout totalement bloqués ! Autre souci les mails sont en status deferred, et seront donc supprimé de la file dans un délai de 5 jours par défaut (voir la configuration demaximal_queue_lifetime). C’est insuffisant pour laisser s’écouler les mails en attente ! Pour les serveurs de mail que je gère j’ai « bidouillé » un script pour vider manuellement la queue pour les mails destinés à Orange/Wanadoo afin que les personnes aient leur mail au plus tôt ! Mais il fallait trouver une solution plus durable… J’en ai mise une en place, elle n’est pas parfaite mais elle a permis de gérer et de délivrer les mailings de ces fêtes de fin d’année en temps et en heure ! Détails de la solution : transport spécifique pour orange/wanadoo /etc/postfix/transport</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class=code><div class=highlight><pre><span></span><code>wanadoo.com slow:
wanadoo.fr slow:
orange.com slow:
orange.fr slow:
puis postmap /etc/postfix/transport
dans /etc/postfix/master.cf

#==========================================================================
# service type private unpriv chroot wakeup maxproc command + args
# (yes) (yes) (yes) (never) (100)
#==========================================================================
slow unix - - n - 5 smtp
-o syslog_name=postfix-slow
-o smtp_destination_concurrency_limit=3
-o slow_destination_rate_delay=1
dans /etc/postfix/main.cf

slow_destination_recipient_limit = 20
slow_destination_concurrency_limit = 2
et finalement : /etc/init.d/postfix reload
Les mails se stockent tout de même en queue, mais la file se vide ensuite relativement rapidement !
orange_destination_recipient_limit = 20
orange_destination_concurrency_limit = 2
orange_destination_concurrency_limit = 3
orange_destination_rate_delay = 1s
</code></pre></div> </td></tr></table> <hr> <div class=md-source-date> <small> Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">September 23, 2020</span> </small> </div> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid" aria-label=Footer> <a href=../opendmarc/ title=Opendmarc class="md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-footer-nav__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer-nav__title> <div class=md-ellipsis> <span class=md-footer-nav__direction> Previous </span> Opendmarc </div> </div> </a> <a href=../whitelisting/ title=Whitelisting class="md-footer-nav__link md-footer-nav__link--next" rel=next> <div class=md-footer-nav__title> <div class=md-ellipsis> <span class=md-footer-nav__direction> Next </span> Whitelisting </div> </div> <div class="md-footer-nav__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2020 HTDocs.dev </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-footer-social> <a href=https://github.com/sbusso target=_blank rel=noopener title=github.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> <a href=https://twitter.com/sbusso target=_blank rel=noopener title=twitter.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg> </a> <a href=https://www.linkedin.com/in/stephanebusso/ target=_blank rel=noopener title=www.linkedin.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg> </a> </div> </div> </div> </footer> </div> <script src=../../../assets/javascripts/vendor.2d1db4bd.min.js></script> <script src=../../../assets/javascripts/bundle.6627ddf3.min.js></script><script id=__lang type=application/json>{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script> <script>
        app = initialize({
          base: "../../..",
          features: ['instant', 'navigation.expand', 'tabs'],
          search: Object.assign({
            worker: "../../../assets/javascripts/worker/search.5eca75d3.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script> </body> </html>