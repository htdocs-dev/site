



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.13">
    
    
      
        <title>Monitoring - HTDOCS</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.077507d7.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#mailgraph-and-pflogsumm" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="../.." title="HTDOCS" class="md-header-nav__button md-logo" aria-label="HTDOCS">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            HTDOCS
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Monitoring
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="HTDOCS" class="md-nav__button md-logo" aria-label="HTDOCS">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    HTDOCS
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Welcome to MkDocs" class="md-nav__link">
      Welcome to MkDocs
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Postfix
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Postfix" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon"></span>
        Postfix
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../advanced_setup/" title="Advanced setup" class="md-nav__link">
      Advanced setup
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../authentication/" title="Authentication" class="md-nav__link">
      Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../bounce/" title="Bounce" class="md-nav__link">
      Bounce
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../conclusion/" title="Conclusion" class="md-nav__link">
      Conclusion
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../dkim_spf/" title="Dkim spf" class="md-nav__link">
      Dkim spf
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../domainkeys/" title="Domainkeys" class="md-nav__link">
      Domainkeys
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../installation/" title="Installation" class="md-nav__link">
      Installation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ip_rotating/" title="Ip rotating" class="md-nav__link">
      Ip rotating
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Monitoring
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" title="Monitoring" class="md-nav__link md-nav__link--active">
      Monitoring
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#mailgraph-and-pflogsumm" class="md-nav__link">
    Mailgraph And pflogsumm
  </a>
  
    <nav class="md-nav" aria-label="Mailgraph And pflogsumm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#42-pflogsumm" class="md-nav__link">
    4.2 pflogsumm
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#simple-bash-monitoring" class="md-nav__link">
    Simple Bash Monitoring
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#another-monitoring-bash-msmtp" class="md-nav__link">
    Another monitoring Bash â€“ MSMTP
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../multidomain/" title="Multidomain" class="md-nav__link">
      Multidomain
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../opendmarc/" title="Opendmarc" class="md-nav__link">
      Opendmarc
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../rate_limiting/" title="Rate limiting" class="md-nav__link">
      Rate limiting
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../whitelisting/" title="Whitelisting" class="md-nav__link">
      Whitelisting
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#mailgraph-and-pflogsumm" class="md-nav__link">
    Mailgraph And pflogsumm
  </a>
  
    <nav class="md-nav" aria-label="Mailgraph And pflogsumm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#42-pflogsumm" class="md-nav__link">
    4.2 pflogsumm
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#simple-bash-monitoring" class="md-nav__link">
    Simple Bash Monitoring
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#another-monitoring-bash-msmtp" class="md-nav__link">
    Another monitoring Bash â€“ MSMTP
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                  <h1>Monitoring</h1>
                
                <h2 id="mailgraph-and-pflogsumm">Mailgraph And pflogsumm</h2>
<p>Want to support HowtoForge? Become a subscriber!
Submitted by falko (Contact Author) (Forums) on Mon, 2006-07-03 15:58. ::</p>
<p>4 Fedora Core 5
4.1 Mailgraph</p>
<p>There's no Mailgraph package available for Fedora Core 5, so we must install it manually. First, we need to install the prerequsities that Mailgraph requires:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>yum install rrdtool rrdtool-perl perl-File-Tail
</code></pre></div>
</td></tr></table>

<p>Then we download the Mailgraph sources and copy the Mailgraph scripts to the appropriate locations:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>cd /tmpâ€¨wget http://people.ee.ethz.ch/~dws/software/mailgraph/pub/mailgraph-1.12.tar.gzâ€¨tar xvfz mailgraph-1.12.tar.gzâ€¨cd mailgraph-1.12â€¨mv mailgraph.pl /usr/local/bin/mailgraph.plâ€¨mv mailgraph-init /etc/init.d/mailgraph
</code></pre></div>
</td></tr></table>

<p>Now we must adjust the Mailgraph init script /etc/init.d/mailgraph:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>vi /etc/init.d/mailgraph
</code></pre></div>
</td></tr></table>

<p>On Fedora, the Postfix mail log is /var/log/maillog, so we change</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>MAIL_LOG=/var/log/syslog
MAIL_LOG=/var/log/maillog
</code></pre></div>
</td></tr></table>

<p>Then we add another variable to /etc/init.d/mailgraph, IGNORE_LOCALHOST. If you have integrated a content filter like amavisd into Postfix, add this line</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>IGNORE_LOCALHOST=&quot;--ignore-localhost&quot;
</code></pre></div>
</td></tr></table>

<p>to the block where the variables like MAIL_LOG are defined. If you don't use a content filter, add this line instead:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>IGNORE_LOCALHOST=&quot;&quot;
</code></pre></div>
</td></tr></table>

<p>In both cases, change</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>nice -19 $MAILGRAPH_PL -l $MAIL_LOG -d \
        --daemon-pid=$PID_FILE --daemon-rrd=$RRD_DIR
nice -19 $MAILGRAPH_PL -l $MAIL_LOG -d \
        --daemon-pid=$PID_FILE --daemon-rrd=$RRD_DIR $IGNORE_LOCALHOST
</code></pre></div>
</td></tr></table>

<p>So the final script should look like this (in this case, with --ignore-localhost enabled):</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>#!/bin/sh

# $Id: mailgraph-init,v 1.4 2005/06/13 11:23:22 dws Exp $
# example init script for mailgraph
#
# chkconfig: 2345 82 28
# description: mailgraph postfix log grapher.
#
# processname: mailgraph.pl
# pidfile: /var/run/mailgraph.pid


PATH=/bin:/usr/bin
MAILGRAPH_PL=/usr/local/bin/mailgraph.pl
MAIL_LOG=/var/log/maillog
PID_FILE=/var/run/mailgraph.pid
RRD_DIR=/var/lib
IGNORE_LOCALHOST=&quot;--ignore-localhost&quot;

case &quot;$1&quot; in
&#39;start&#39;)
        echo &quot;Starting mail statistics grapher: mailgraph&quot;;
        nice -19 $MAILGRAPH_PL -l $MAIL_LOG -d \
                --daemon-pid=$PID_FILE --daemon-rrd=$RRD_DIR $IGNORE_LOCALHOST
        ;;

&#39;stop&#39;)
        echo &quot;Stopping mail statistics grapher: mailgraph&quot;;
        if [ -f $PID_FILE ]; then
                kill `cat $PID_FILE`
                rm $PID_FILE
        else
                echo &quot;mailgraph not running&quot;;
        fi
        ;;

*)
        echo &quot;Usage: $0 { start | stop }&quot;
        exit 1
        ;;

esac
exit 0
</code></pre></div>
</td></tr></table>

<p>Next we make the script executable, create the appropriate system startup links and start Mailgraph:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>chmod 755 /etc/init.d/mailgraphâ€¨chkconfig --levels 235 mailgraph onâ€¨/etc/init.d/mailgraph start
</code></pre></div>
</td></tr></table>

<p>Still in the /tmp/mailgraph-1.12 directory, we move mailgraph.cgi to our cgi-bin directory:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>mv mailgraph.cgi /var/www/www.example.com/cgi-bin/
</code></pre></div>
</td></tr></table>

<p>Now we open the file and adjust the locations of the two Mailgraph databases.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>vi /var/www/www.example.com/cgi-bin/mailgraph.cgi
</code></pre></div>
</td></tr></table>

<p>Change</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>my $rrd = &#39;mailgraph.rrd&#39;; # path to where the RRD database is
my $rrd_virus = &#39;mailgraph_virus.rrd&#39;; # path to where the Virus RRD database is
my $rrd = &#39;/var/lib/mailgraph.rrd&#39;; # path to where the RRD database is
my $rrd_virus = &#39;/var/lib/mailgraph_virus.rrd&#39;; # path to where the Virus RRD database is
</code></pre></div>
</td></tr></table>

<p>Then we make the script executable:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>chmod 755 /var/www/www.example.com/cgi-bin/mailgraph.cgi
</code></pre></div>
</td></tr></table>

<p>If you use suExec for the www.example.com web site, you must chown mailgraph.cgi to the appropriate owner and group.</p>
<p>Now direct your browser to http://www.example.com/cgi-bin/mailgraph.cgi, and you should see some graphs. Of course, there must be some emails going through your system before you see the first results, so be patient.</p>
<h3 id="42-pflogsumm">4.2 pflogsumm</h3>
<p>The steps differ only slightly from those on Debian and Ubuntu. The main difference is that Postfix logs to /var/log/maillog on Fedora instead of /var/log/mail.log (Debian/Ubuntu) (pay attention to the dot!).</p>
<p>First we install pflogsumm:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>yum install postfix-pflogsumm
</code></pre></div>
</td></tr></table>

<p>We want pflogsumm to be run by a cron job each day and send the report to postmaster@example.com. Therefore we must configure our system that it writes one mail log file for 24 hours, and afterwards starts the next mail log so that we can feed the old mail log to pflogsumm. Therefore we configure logrotate (that's the program that rotates our system's log files) like this: open /etc/logrotate.conf and append the following stanza to it, after the line # system-specific logs may be configured here:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>vi /etc/logrotate.conf
/var/log/maillog {
    missingok
    daily
    rotate 7
    create
    compress
    start 0
}
Also change /etc/logrotate.d/syslog
vi /etc/logrotate.d/syslog
/var/log/messages /var/log/secure /var/log/maillog /var/log/spooler /var/log/boot.log /var/log/cron {
    sharedscripts
    postrotate
        /bin/kill -HUP `cat /var/run/syslogd.pid 2&gt; /dev/null` 2&gt; /dev/null || true
    endscript
}
/var/log/messages /var/log/secure /var/log/spooler /var/log/boot.log /var/log/cron {
    sharedscripts
    postrotate
        /bin/kill -HUP `cat /var/run/syslogd.pid 2&gt; /dev/null` 2&gt; /dev/null || true
    endscript
}
</code></pre></div>
</td></tr></table>

<p>There's a logrotate script in /etc/cron.daily. This script is called everyday between 06:00h and 07:00h. With the configuration we just made, it will copy the current Postfix log /var/log/maillog to /var/log/maillog.0 and compress it, and the compressed file will be /var/log/maillog.0.gz. It will also create a new, empty /var/log/maillog to which Postfix can log for the next 24 hours.</p>
<p>Now we create the script /usr/local/sbin/postfix_report.sh which invokes pflogsumm and makes it send the report to postmaster@example.com:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>vi /usr/local/sbin/postfix_report.sh
#!/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
gunzip /var/log/maillog.0.gz

pflogsumm /var/log/maillog.0 | formail -c -I&quot;Subject: Mail Statistics&quot; -I&quot;From: pflogsumm@localhost&quot; -I&quot;To: postmaster@example.com&quot; -I&quot;Received: from www.example.com ([192.168.0.100])&quot; | sendmail postmaster@example.com

gzip /var/log/maillog.0
exit 0
</code></pre></div>
</td></tr></table>

<p>We must make this script executable:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>chmod 755 /usr/local/sbin/postfix_report.sh
</code></pre></div>
</td></tr></table>

<p>Then we create a cron job which calls the script everyday at 07:00h:</p>
<p>crontab -e 0 7 * * * /usr/local/sbin/postfix_report.sh &amp;&gt; /dev/null</p>
<p>This will send the report to postmaster@example.com.</p>
<p>mailgraph statistics for postfix running on nginx</p>
<p>Iâ€™m using postfix as my mail server. In order to get nice graphical overview about the server activity Iâ€™m using mailgraph.â€¨Mailgraph is a cgi script written in perl. It uses rrdtool to produce daily, weekly, monthly and yearly graphs of received/sent and bounced/rejected mail.</p>
<p>Installing mailgraph on debian is as easy as running:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>aptitude install mailgraph
</code></pre></div>
</td></tr></table>

<p>The configuration takes place in /etc/default/mailgraph. Make sure to modify it according to your mail setup.
In order to run in on nginx server, one needs to install fcgiwrap and spawn-fcgi first. Nothing simpler than that:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>aptitude install fcgiwrap spawn-fcgi
</code></pre></div>
</td></tr></table>

<p>Configuring nginx to use fcgiwrap requires the following:</p>
<p>Creation of the /etc/nginx/conf.d/fcgiwrap.conf file with the following content:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>.   upstream fcgiwrap {
.      server unix:/var/run/fcgiwrap.socket;
.   }
.   Instructions to the nginx, to pass the cgi scripts to fcgiwrap (done in the server section for the virtual host):
.   location ~ \.cgi$ {
.      root /usr/lib/cgi-bin;
.      include /etc/nginx/fastcgi_params;
.      fastcgi_pass fcgiwrap;
.   }
</code></pre></div>
</td></tr></table>

<p>The result for weekly statistics looks like shown below:</p>
<h2 id="simple-bash-monitoring">Simple Bash Monitoring</h2>
<p>You can monitor the queues with a simple bashscript:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>#!/bin/bash # 20.06.2011 - JJaritsch @ ANEXIA Internetdienstleistungs GmbH # jj@anexia.at  queuelength=`/usr/sbin/postqueue -p | tail -n1 | awk &#39;{print $5}&#39;` queuecount=`echo $queuelength | grep &quot;[0-9]&quot;`  if [ &quot;$queuecount&quot; == &quot;&quot; ]; then         echo 0; else         echo ${queuelength}; fi exit 35
</code></pre></div>
</td></tr></table>

<p>Save this script and make it executable (0755 is enough) for the snmpd user. The next step is to add the following line to your snmpd.conf:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>exec postqueue /path/to/your/snmp_monitor_postqueue.sh
</code></pre></div>
</td></tr></table>

<p>If you want to use sudo, you can add this line:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>exec postqueue /usr/bin/sudo /path/to/your/snmp_monitor_postqueue.sh
</code></pre></div>
</td></tr></table>

<p>In case of sudo you also have to add the following to your sudoers file (so there is no auth required to execute this script):</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>snmp ALL=(ALL) NOPASSWD: /path/to/your/snmp_monitor_postqueue.sh
</code></pre></div>
</td></tr></table>

<p>Reload your snmpd - you will find the count-result in .1.3.6.1.4.1.2021.8.1.101.* (for example in .1.3.6.1.4.1.2021.8.1.101.1 if you have no other additional lines in the snmpd.conf).</p>
<h2 id="another-monitoring-bash-msmtp">Another monitoring Bash â€“ MSMTP</h2>
<p>In addition to Bryan Rehbein's answer above, here's a script I use to monitor postfix queue lengths. All it does is send an email alert once a queue grows beyond X messages in size. The alert is sent using msmtp (a tiny command line smtp client) so it bypasses the local postfix installation (which you can't rely on to get your alert out in a timely fashion if its queues are growing...)</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>#!/bin/bash
# # Postfix queue length monitoring script (requires msmtp)
# # This script checks the active, incoming, deferred and maildrop postfix queue directories.
# # If the number of messages in any of these directories is more than $MAX_QUEUE_LENGTH,
# the script will generate an alert email and send it using msmtp. We use msmtp so that # we can bypass the local postfix installation (since if the queues are getting big, # the alert email may not be sent in time to catch the problem).
#  ########################################################
# # SET SCRIPT VARS ########################################################
#  # Path to msmtp binary (e.g. /usr/bin/msmtp on Debian systems) MSMTP=/usr/bin/msmtp
# Remote mail host (this is the mail server msmtp will use to send the alert. It should NOT be the local postfix installation) MAILHOST=backup.mailserver.com
# Remote mail port MAILPORT=25
# Mail protocol MAILPROTO=smtp
# Fully qualified domain name of local postfix installation DOMAIN=primary.mailserver.com
# From address MAILFROM=postmaster@mailserver.com
# Recipient (this address should not route to the local postfix installation, for obvious reasons) MAILTO=&quot;alerts@anotherdomain.com&quot;
# Email subject MAILSUBJECT=&quot;Postfix queue length alert for ${DOMAIN}&quot;  # MSMTP log file LOGFILE=/var/log/msmtp.log
# Root of the postfix queue dirs (e.g. /var/spool/postfix on Debian systems). Note: no trailing slash. QUEUEDIR_ROOT=&quot;/var/spool/postfix&quot;
# Max queue length (if there are more messages in a queue than this number, we will send an alert) MAX_QUEUE_LENGTH=10   #########################################################
# SCRIPT LOGIC STARTS HERE #########################################################

# Check msmtp binary exists

if [ ! -f ${MSMTP} ] then         echo &quot;Cannot find ${MSMTP}. Exiting.&quot;         exit 1 fi  # Get the number of messages sitting in each postfix queue directory Q_ACTIVE=$(find ${QUEUEDIR_ROOT}/active -type f | wc -l) Q_INCOMING=$(find ${QUEUEDIR_ROOT}/incoming -type f | wc -l) Q_DEFERRED=$(find ${QUEUEDIR_ROOT}/deferred -type f | wc -l) Q_MAILDROP=$(find ${QUEUEDIR_ROOT}/maildrop -type f | wc -l)  # If any of these queues contain more than $MAX_QUEUE_LENGTH issue an alert if [ ${Q_ACTIVE} -gt ${MAX_QUEUE_LENGTH} -o ${Q_INCOMING} -gt ${MAX_QUEUE_LENGTH} -o ${Q_DEFERRED} -gt ${MAX_QUEUE_LENGTH} -o ${Q_MAILDROP} -gt ${MAX_QUEUE_LENGTH} ]; then      (         echo &quot;From: ${MAILFROM} &quot;         echo &quot;To: ${MAILTO} &quot;         echo &quot;Mime-Version: 1.0&quot;         echo &#39;Content-Type: text/plain; charset=&quot;iso-8859-1&quot;&#39;         echo &quot;Subject: ${MAILSUBJECT}&quot;         echo &quot;&quot;         echo &quot;One or more of the postfix queues on ${DOMAIN} has grown beyond ${MAX_QUEUE_LENGTH} messages in length.&quot;     ) | ${MSMTP} --host=${MAILHOST} --port=${MAILPORT} --protocol=${MAILPROTO} --domain=${DOMAIN} --auth=off --tls=off --from=${MAILFROM} --logfile=${LOGFILE} --syslog=off --read-recipients      exit 2  fi  exit 0
</code></pre></div>
</td></tr></table>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../ip_rotating/" title="Ip rotating" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Ip rotating
              </div>
            </div>
          </a>
        
        
          <a href="../multidomain/" title="Multidomain" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Multidomain
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.2d1db4bd.min.js"></script>
      <script src="../../assets/javascripts/bundle.6627ddf3.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.5eca75d3.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>