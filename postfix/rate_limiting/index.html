



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.13">
    
    
      
        <title>Rate limiting - HTDOCS</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.077507d7.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#61-add-policies-in-etcpostfixmastercf" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="../.." title="HTDOCS" class="md-header-nav__button md-logo" aria-label="HTDOCS">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            HTDOCS
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Rate limiting
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="HTDOCS" class="md-nav__button md-logo" aria-label="HTDOCS">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    HTDOCS
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Welcome to MkDocs" class="md-nav__link">
      Welcome to MkDocs
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Postfix
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Postfix" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon"></span>
        Postfix
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../advanced_setup/" title="Advanced setup" class="md-nav__link">
      Advanced setup
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../authentication/" title="Authentication" class="md-nav__link">
      Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../bounce/" title="Bounce" class="md-nav__link">
      Bounce
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../conclusion/" title="Conclusion" class="md-nav__link">
      Conclusion
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../dkim_spf/" title="Dkim spf" class="md-nav__link">
      Dkim spf
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../domainkeys/" title="Domainkeys" class="md-nav__link">
      Domainkeys
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../installation/" title="Installation" class="md-nav__link">
      Installation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ip_rotating/" title="Ip rotating" class="md-nav__link">
      Ip rotating
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../monitoring/" title="Monitoring" class="md-nav__link">
      Monitoring
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../multidomain/" title="Multidomain" class="md-nav__link">
      Multidomain
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../opendmarc/" title="Opendmarc" class="md-nav__link">
      Opendmarc
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
    <a href="./" title="Rate limiting" class="md-nav__link md-nav__link--active">
      Rate limiting
    </a>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../whitelisting/" title="Whitelisting" class="md-nav__link">
      Whitelisting
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                <p>References:</p>
<p>(http://steam.io/2013/04/01/postfix-rate-limiting/)
http://wiki.wordtothewise.com/ISP_Summary_Information</p>
<h2 id="61-add-policies-in-etcpostfixmastercf">6.1. Add policies in /etc/postfix/master.cf</h2>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>polite unix - - n - - smtp
turtle unix - - n - - smtp
</code></pre></div>
</td></tr></table>

<ol>
<li>
<p>Map domain to its transport name. For this add the following to <code>/etc/postfix/transport</code></p>
<p>gmail.com polite:
yahoo.com turtle:
hotmail.com polite:
aol.com turtle:</p>
</li>
<li>
<p>Modify postfix configuration to specify the rate limit,</p>
<p>postconf -e "polite_destination_concurrency_limit = 4"
postconf -e "polite_destination_rate_delay = 0"
postconf -e "polite_destination_recipient_limit = 10"
postconf -e "turtle_destination_rate_delay = 3s"
postconf -e "turtle_destination_concurrency_limit = 20"
postconf -e "turtle_destination_recipient_limit = 4"</p>
</li>
</ol>
<p>Restart postfix</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>service postfix restart
</code></pre></div>
</td></tr></table>

<p>other solution</p>
<p>Now, define required additional transport in postfix master.cf file:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>smtp-gmail unix -    -    n    -    1    smtp
      -o syslog_name=smtp-gmail
</code></pre></div>
</td></tr></table>

<p>Define the required throttling (rate limits) settings in postfix main.cf</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>smtp-gmail_destination_rate_delay = 12s
smtp-gmail_destination_concurrency_limit = 1
smtp-gmail_destination_recipient_limit = 2
smtp-gmail_initial_destination_concurrency=1
</code></pre></div>
</td></tr></table>

<p>The syntax is as follows: <code>transtport-name_variable-name=value</code></p>
<p>Add the following to /etc/postfix/transport</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>/\@gmail\.com$/       smtp-gmail:
</code></pre></div>
</td></tr></table>

<p>The format of the above file is regexp. Lookups to regexp tables are fast so probably you should use those. For regexp to work you should have regexp support built into postfix. Find out using this command</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>postconf -m
</code></pre></div>
</td></tr></table>

<p>Once the transport file is created, make sure to create the corresponding db, which will be actually used by postfix. Use postmap command.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>  postmap  /etc/postfix/transport
</code></pre></div>
</td></tr></table>

<p>Make postfix use this transport table. Edit main.cf and add the following:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>transport_maps = regexp:/etc/postfix/transport
</code></pre></div>
</td></tr></table>

<p>Make sure you use regexp prefix.</p>
<p>Reload postfix</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>postfix reload



transport_maps = hash:/etc/postfix/transport, regexp:/etc/postfix/transport_gmail

# cat /etc/postfix/transport_gmail
/\@gmail\.com$/ smtp-gmail:
</code></pre></div>
</td></tr></table>

<p>!!! note
    No need to postmap this file</p>
<p>Delay=2s caused transport invocation every 4 seconds in my experience.</p>
<p><code>/etc/postfix/transport</code> file  like this:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code># Yahoo (USA)
yahoo.com       yahoo:
ymail.com       yahoo:
rocketmail.com  yahoo:

# Yahoo (INTL)
yahoo.ae        yahoo:
yahoo.at        yahoo:
yahoo.be        yahoo:
yahoo.ca        yahoo:
yahoo.ch        yahoo:
yahoo.cn        yahoo:
yahoo.co.il     yahoo:
yahoo.co.in     yahoo:
yahoo.co.jp     yahoo:
yahoo.co.kr     yahoo:
yahoo.co.nz     yahoo:
yahoo.co.th     yahoo:
yahoo.co.uk     yahoo:
yahoo.co.za     yahoo:
yahoo.com.ar    yahoo:
yahoo.com.au    yahoo:
yahoo.com.br    yahoo:
yahoo.com.cn    yahoo:
yahoo.com.hk    yahoo:
yahoo.com.mx    yahoo:
yahoo.com.my    yahoo:
yahoo.com.ph    yahoo:
yahoo.com.sg    yahoo:
yahoo.com.tr    yahoo:
yahoo.com.tw    yahoo:
yahoo.com.vn    yahoo:
yahoo.cz        yahoo:
yahoo.de        yahoo:
yahoo.dk        yahoo:
yahoo.en        yahoo:
yahoo.es        yahoo:
yahoo.fi        yahoo:
yahoo.fr        yahoo:
yahoo.gr        yahoo:
yahoo.ie        yahoo:
yahoo.it        yahoo:
yahoo.nl        yahoo:
yahoo.no        yahoo:
yahoo.pl        yahoo:
yahoo.pt        yahoo:
yahoo.ro        yahoo:
yahoo.ru        yahoo:
yahoo.se        yahoo:
# Yahoo
ymail.com       yahoo:
rocketmail.com  yahoo:
yahoo.com   smtpslow:
gmail.com   smtpslow:
hotmail.com smtpslow:
aol.com     smtpslow:
comcast.com smtpslow:
live.com    smtpslow:
msn.com     smtpslow:
sbcglobal.net smtpslow:
verizon.net     smtpslow:
bellsouth.net smtpslow:
yahoo.ca    smtpslow:
cox.net     smtpslow:
ymail.com   smtpslow:
</code></pre></div>
</td></tr></table>

<p>Once you’re done editing the /etc/postfix/transport file (and after every edit from now on), remember to do:
    # postmap /etc/postfix/transport</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>/etc/postfix/transport.regexp that looks like this:

# Yahoo Wildcards
/yahoo(\.[a-z]{2,3}){1,2}$/  yahoo:

yahoo     unix  -       -       n       -       -       smtp
        -o syslog_name=postfix-yahoo
</code></pre></div>
</td></tr></table>

<p>Back up your /etc/postfix/main.cf file, then add these lines:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>transport_maps = hash:/etc/postfix/transport, regexp:/etc/postfix/transport.regexp

yahoo_initial_destination_concurrency = 1
yahoo_destination_concurrency_limit = 4
yahoo_destination_recipient_limit = 2
yahoo_destination_rate_delay = 1s
</code></pre></div>
</td></tr></table>

<p>This tells Postfix to check your /etc/postfix/transport and /etc/postfix/transport.regexp files to look up which domains you’ve mapped to which transport, then it sets four specific configurations for the “yahoo” transport:</p>
<ul>
<li><code>yahoo_initial_destination_concurrency = 1</code> will start out slowly by only sending one message per SMTP connection to a Yahoo’s MTA.</li>
<li><code>yahoo_destination_concurrency_limit = 4</code> after starting out slowly with just 1 message, Postfix will increase to allow up to four messages per SMTP connection to a Yahoo MTA.</li>
<li><code>yahoo_destination_recipient_limit = 2</code> will send the same message to no more than 2 recipients at a time</li>
<li><code>yahoo_destination_rate_delay = 1s</code> will add a 1 second delay between the messages</li>
</ul>
<p>final version:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>/pronostic-facile\.fr/ relay:[ASPMX.L.GOOGLE.COM]

/gmail\.com/ polite:
/yahoo\.com/ turtle:
/hotmail(\.[a-z]{2,3}){1,2}$/ polite:
/live(\.[a-z]{2,3}){1,2}$/ polite:
/outlook(\.[a-z]{2,3}){1,2}$/ polite:
/aol\.com/  turtle:
/yahoo(\.[a-z]{2,3}){1,2}$/ turtle:
</code></pre></div>
</td></tr></table>

<p>Basically, you may take the following steps as reference:</p>
<ul>
<li>
<p>Create a seperate mail for the destination is yahoo, let's name it 'slow' queue
(You may search in this mailling list too, someone has asked before)</p>
</li>
<li>
<p>After Postfix 2.5, set slow_destination_rate_delay for certain period of time for 'slow'
    In my case, I set to 300s. That's mean 5 mins per delivery to yahoo</p>
</li>
<li>
<p>Set slow_destination_concurrency_limit &amp; slow_destination_recipient_limit for 'slow'
    In may case, I set
   slow_destination_concurrency_limit = 2
   slow_destination_recipient_limit = 10</p>
</li>
<li>
<p>In Postfix 2.5.5 or earlier, disable defer retry failure giving up limit for 'slow'.
    I my case, I set
   slow_concurrency_failed_cohort_limit = $slow_destination_concurrency_failed_cohort_limit
   slow_destination_concurrency_failed_cohort_limit = 0</p>
</li>
</ul>
<h2 id="step-1-setting-up-the-transport-maps">STEP 1: SETTING UP THE TRANSPORT MAPS</h2>
<p>The first step is to determine which domains you want to treat differently. Obviously, in this example, we’re trying to set up something to eliminate (or at least reduce) Yahoo’s deferrals. So edit the /etc/postfix/transport file and create some maps that tell Postfix exactly which email domains are going to get the special “Yahoo” treatment. The email domain goes on the left, and the name of your custom transport goes on the right (always followed by a colon). The most basic approach would be to specifically list all the Yahoo email domains you want to cover in your /etc/postfix/transport file  like this:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code># Yahoo (USA) yahoo.com       yahoo: ymail.com       yahoo: rocketmail.com  yahoo:  # Yahoo (INTL) yahoo.ae        yahoo: yahoo.at        yahoo: yahoo.be        yahoo: yahoo.ca        yahoo: yahoo.ch        yahoo: yahoo.cn        yahoo: yahoo.co.il     yahoo: yahoo.co.in     yahoo: yahoo.co.jp     yahoo: yahoo.co.kr     yahoo: yahoo.co.nz     yahoo: yahoo.co.th     yahoo: yahoo.co.uk     yahoo: yahoo.co.za     yahoo: yahoo.com.ar    yahoo: yahoo.com.au    yahoo: yahoo.com.br    yahoo: yahoo.com.cn    yahoo: yahoo.com.hk    yahoo: yahoo.com.mx    yahoo: yahoo.com.my    yahoo: yahoo.com.ph    yahoo: yahoo.com.sg    yahoo: yahoo.com.tr    yahoo: yahoo.com.tw    yahoo: yahoo.com.vn    yahoo: yahoo.cz        yahoo: yahoo.de        yahoo: yahoo.dk        yahoo: yahoo.en        yahoo: yahoo.es        yahoo: yahoo.fi        yahoo: yahoo.fr        yahoo: yahoo.gr        yahoo: yahoo.ie        yahoo: yahoo.it        yahoo: yahoo.nl        yahoo: yahoo.no        yahoo: yahoo.pl        yahoo: yahoo.pt        yahoo: yahoo.ro        yahoo: yahoo.ru        yahoo: yahoo.se        yahoo:
</code></pre></div>
</td></tr></table>

<p>However, listing all those domains forces you to stay up to date with any new domains that Yahoo might launch. So a smarter approach would be to two transport maps: one that’s a regular hash table, and another with a regular expression that simply catches any domain that starts with yahoo.
First, put ymail.com and rocketmail.com in your /etc/postfix/transport file, like this:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code># Yahoo ymail.com
yahoo: rocketmail.com  yahoo:
</code></pre></div>
</td></tr></table>

<p>Once you’re done editing the /etc/postfix/transport file (and after every edit from now on), remember to do:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>postmap /etc/postfix/transport
</code></pre></div>
</td></tr></table>

<p>to build the transport.db file.
Next, create a file called /etc/postfix/transport.regexp that looks like this:</p>
<h1 id="yahoo-wildcards-yahooa-z2312-yahoo">Yahoo Wildcards /yahoo(.[a-z]{2,3}){1,2}$/  yahoo:</h1>
<p>That will catch all “yahoo dot anything” domains. Note that you don’t need to run postmap on regular expression tables, so now you’re ready to tell Postfix how to read your transports.
Step 2: Include the New Custom Transports in master.cf
As always, before messing with /etc/postfix/master.cf, make a backup. Then add the following lines at the bottom:
yahoo     unix  -       -       n       -       -       smtp         -o syslog_name=postfix-yahoo
-o smtp_connect_timeout=5 -o smtp_helo_timeout=5</p>
<p>This tells Postfix that the transport called “yahoo” gets handed off to the Postfix smtp process, and the -o syslog_name option tags the use of this transport in the mail log so I easily tell when this transport is used.
Step 3: Create Custom Settings in main.cf
The third step of the process is to create some custom settings in your main.cf file to tell Postfix exactly what to do differently when it encounters an outbound mail domain that matches your transport maps. Back up your /etc/postfix/main.cf file, then add these lines:
transport_maps = hash:/etc/postfix/transport, regexp:/etc/postfix/transport.regexp  yahoo_initial_destination_concurrency = 1 yahoo_destination_concurrency_limit = 4 yahoo_destination_recipient_limit = 2
yahoo_destination_rate_delay = 1s
This tells Postfix to check your /etc/postfix/transport and/etc/postfix/transport.regexp files to look up which domains you’ve mapped to which transport, then it sets four specific configurations for the “yahoo” transport:
•   yahoo_initial_destination_concurrency = 1 will start out slowly by only sending one message per SMTP connection to a Yahoo’s MTA.
•   yahoo_destination_concurrency_limit = 4 after starting out slowly with just 1 message, Postfix will increase to allow up to four messages per SMTP connection to a Yahoo MTA.
•   yahoo_destination_recipient_limit = 2 will send the same message to no more than 2 recipients at a time
•   yahoo_destination_rate_delay = 1s will add a 1 second delay between the messages
This is where the Postfix voodoo kicks in for me, so feel free to experiment with these settings and tweak to your liking. The destination concurrency limit and the rate delay are the two you’ll probably want to tinker to keep Yahoo happy. Depending on your mailer reputation, they’ll be more strict or more relaxed on what they’ll allow for these two settings. The above settings that happen to work for my needs, but I still tweak them to experiment, and if you have a configuration that works well with Yahoo (or if you have other custom transports that help increase delivery), please feel free to share them in the comments.
Step 4: Restart Postfix and Test
Now you’re ready to try things out. Start the Postfix configuration with:</p>
<h1 id="service-postfix-restart">service postfix restart</h1>
<p>You can’t just do a postfix reload, because changes to the master.cf require a full restart. Finally, do a tail -f on your maillog. On my CentOS system, that’s:
 tail -f /var/log/maillog
Now send a message to a Yahoo test account (I’m assuming you have an @yahoo.com test account) from or through your Postfix server. If everything worked right, you should see log entries that start with the date, local hostname, and then say postfix-yahoo/smtp. These are the messages that are being diverted through your new transport!
After using these settings for a few mailings, I’ve seen a drastic reduction in the amount of time it takes to deliver tens of thousands of opt-in email to Yahoo recipients. Hopefully, they’ll work for you, too!
Your feedback and comments are welcome below, and I’m especially interested to hear of any other custom transports you may be using, as well as your experiences with different settings for Yahoo.
 
La file des messages se rempli alors très rapidement pour monter facilement à plusieurs dizaine de milliers de mails en attente d’envoi et surtout totalement bloqués !
Autre souci les mails sont en status deferred, et seront donc supprimé de la file dans un délai de 5 jours par défaut (voir la configuration demaximal_queue_lifetime). C’est insuffisant pour laisser s’écouler les mails en attente !
Pour les serveurs de mail que je gère j’ai « bidouillé » un script pour vider manuellement la queue pour les mails destinés à Orange/Wanadoo afin que les personnes aient leur mail au plus tôt !
Mais il fallait trouver une solution plus durable…
J’en ai mise une en place, elle n’est pas parfaite mais elle a permis de gérer et de délivrer les mailings de ces fêtes de fin d’année en temps et en heure !
Détails de la solution : transport spécifique pour orange/wanadoo
/etc/postfix/transport</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>wanadoo.com slow:
wanadoo.fr slow:
orange.com slow:
orange.fr slow:
puis postmap /etc/postfix/transport
dans /etc/postfix/master.cf

#==========================================================================
# service type private unpriv chroot wakeup maxproc command + args
# (yes) (yes) (yes) (never) (100)
#==========================================================================
slow unix - - n - 5 smtp
-o syslog_name=postfix-slow
-o smtp_destination_concurrency_limit=3
-o slow_destination_rate_delay=1
dans /etc/postfix/main.cf

slow_destination_recipient_limit = 20
slow_destination_concurrency_limit = 2
et finalement : /etc/init.d/postfix reload
Les mails se stockent tout de même en queue, mais la file se vide ensuite relativement rapidement !
orange_destination_recipient_limit = 20
orange_destination_concurrency_limit = 2
orange_destination_concurrency_limit = 3
orange_destination_rate_delay = 1s
</code></pre></div>
</td></tr></table>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../opendmarc/" title="Opendmarc" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Opendmarc
              </div>
            </div>
          </a>
        
        
          <a href="../whitelisting/" title="Whitelisting" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Whitelisting
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.2d1db4bd.min.js"></script>
      <script src="../../assets/javascripts/bundle.6627ddf3.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.5eca75d3.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>